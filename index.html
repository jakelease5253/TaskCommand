<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Task Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const REDIRECT_URI = 'https://blue-sand-0d6d8c00f.3.azurestaticapps.net/';
        const MSAL_CONFIG = {
            auth: {
                clientId: '8724797a-a121-4f6c-bc18-2cc72266a686',
                authority: 'https://login.microsoftonline.com/327a958f-68a1-40f6-aada-48a87827f0b1',
                redirectUri: REDIRECT_URI
            }
        };
        const GRAPH_SCOPES = ['Tasks.ReadWrite', 'Group.Read.All', 'User.Read'];

        const Play = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const Pause = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>;
        const Square = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>;
        const Clock = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const Calendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const Target = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>;
        const RefreshCw = ({ className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;
        const LogOut = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
        const AlertCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const X = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const Check = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"></polyline></svg>;
        const Plus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const Folder = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>;
        const Users = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
        const Edit = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
        const GripVertical = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg>;
        const ChevronUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"></polyline></svg>;
        const ChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const TrendingUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
        const BarChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>;
        const Award = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>;
        const Zap = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>;

        function FocusTaskManager() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [accessToken, setAccessToken] = useState(null);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [plans, setPlans] = useState({});
            const [buckets, setBuckets] = useState({});
            const [userProfiles, setUserProfiles] = useState({});
            const [showNewTaskModal, setShowNewTaskModal] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [focusTask, setFocusTask] = useState(null);
            const [focusStartTime, setFocusStartTime] = useState(null);
            const [focusElapsed, setFocusElapsed] = useState(0);
            const [isWorkTimerRunning, setIsWorkTimerRunning] = useState(false);
            const [workStartTime, setWorkStartTime] = useState(null);
            const [workElapsed, setWorkElapsed] = useState(0);
            const [sortMode, setSortMode] = useState('myOrder');
            const [customOrder, setCustomOrder] = useState([]);
            const [draggedTask, setDraggedTask] = useState(null);
            const [dateRange, setDateRange] = useState('7days');
            const [showDashboard, setShowDashboard] = useState(true);
            const [completedTasksHistory, setCompletedTasksHistory] = useState([]);

            // Load completed tasks history
            useEffect(() => {
                const savedHistory = localStorage.getItem('completedTasksHistory');
                if (savedHistory) {
                    try {
                        setCompletedTasksHistory(JSON.parse(savedHistory));
                    } catch (err) {
                        console.error('Error loading completed tasks history:', err);
                    }
                }
            }, []);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                if (code) {
                    acquireToken(code);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, []);

            useEffect(() => {
                let interval;
                if (focusTask && focusStartTime) {
                    interval = setInterval(() => {
                        setFocusElapsed(Math.floor((Date.now() - focusStartTime) / 1000));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [focusTask, focusStartTime]);

            useEffect(() => {
                let interval;
                if (isWorkTimerRunning && workStartTime) {
                    interval = setInterval(() => {
                        setWorkElapsed(Math.floor((Date.now() - workStartTime) / 1000));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isWorkTimerRunning, workStartTime]);

            useEffect(() => {
                if (isAuthenticated && accessToken) {
                    fetchUserProfile();
                    fetchAllTasks();
                }
            }, [isAuthenticated, accessToken]);

            useEffect(() => {
                const saved = localStorage.getItem('customTaskOrder');
                if (saved) {
                    try {
                        setCustomOrder(JSON.parse(saved));
                    } catch (err) {
                        console.error('Error loading custom order:', err);
                    }
                }
            }, []);

            useEffect(() => {
                if (customOrder.length > 0) {
                    localStorage.setItem('customTaskOrder', JSON.stringify(customOrder));
                }
            }, [customOrder]);

            const handleLogin = () => {
                const authUrl = `${MSAL_CONFIG.auth.authority}/oauth2/v2.0/authorize?` +
                    `client_id=${MSAL_CONFIG.auth.clientId}` +
                    `&response_type=code` +
                    `&redirect_uri=${encodeURIComponent(MSAL_CONFIG.auth.redirectUri)}` +
                    `&response_mode=query` +
                    `&scope=${encodeURIComponent(GRAPH_SCOPES.join(' '))}` +
                    `&state=12345`;
                window.location.href = authUrl;
            };

            const acquireToken = async (code) => {
                setLoading(true);
                try {
                    const response = await fetch(`${MSAL_CONFIG.auth.authority}/oauth2/v2.0/token`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: new URLSearchParams({
                            client_id: MSAL_CONFIG.auth.clientId,
                            scope: GRAPH_SCOPES.join(' '),
                            code: code,
                            redirect_uri: MSAL_CONFIG.auth.redirectUri,
                            grant_type: 'authorization_code'
                        })
                    });
                    const data = await response.json();
                    if (data.access_token) {
                        setAccessToken(data.access_token);
                        setIsAuthenticated(true);
                    } else {
                        throw new Error('Failed to acquire token');
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const fetchUserProfile = async () => {
                try {
                    const response = await fetch('https://graph.microsoft.com/v1.0/me', {
                        headers: {'Authorization': `Bearer ${accessToken}`}
                    });
                    const data = await response.json();
                    setUser(data);
                } catch (err) {
                    console.error('Error fetching user profile:', err);
                }
            };

            const fetchAllTasks = async () => {
                setLoading(true);
                try {
                    const groupsResponse = await fetch('https://graph.microsoft.com/v1.0/me/planner/plans', {
                        headers: {'Authorization': `Bearer ${accessToken}`}
                    });
                    const groupsData = await groupsResponse.json();
                    const plansMap = {};
                    groupsData.value.forEach(plan => {
                        plansMap[plan.id] = plan.title;
                    });
                    setPlans(plansMap);

                    const bucketsMap = {};
                    for (const planId of Object.keys(plansMap)) {
                        const bucketsResponse = await fetch(`https://graph.microsoft.com/v1.0/planner/plans/${planId}/buckets`, {
                            headers: {'Authorization': `Bearer ${accessToken}`}
                        });
                        const bucketsData = await bucketsResponse.json();
                        bucketsMap[planId] = bucketsData.value;
                    }
                    setBuckets(bucketsMap);

                    const tasksResponse = await fetch('https://graph.microsoft.com/v1.0/me/planner/tasks', {
                        headers: {'Authorization': `Bearer ${accessToken}`}
                    });
                    const tasksData = await tasksResponse.json();
                    setTasks(tasksData.value || []);

                    const userIds = new Set();
                    tasksData.value?.forEach(task => {
                        if (task.assignments) {
                            Object.keys(task.assignments).forEach(userId => userIds.add(userId));
                        }
                    });

                    const profiles = {};
                    for (const userId of userIds) {
                        try {
                            const userResponse = await fetch(`https://graph.microsoft.com/v1.0/users/${userId}`, {
                                headers: {'Authorization': `Bearer ${accessToken}`}
                            });
                            const userData = await userResponse.json();
                            profiles[userId] = userData.displayName || userData.userPrincipalName || 'Unknown';
                        } catch (err) {
                            profiles[userId] = 'Unknown';
                        }
                    }
                    setUserProfiles(profiles);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = () => {
                setIsAuthenticated(false);
                setAccessToken(null);
                setUser(null);
                setTasks([]);
                setPlans({});
                setBuckets({});
            };

            const handleCompleteTask = async (taskId) => {
                try {
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return;

                    const detailsResponse = await fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${taskId}/details`, {
                        headers: {'Authorization': `Bearer ${accessToken}`}
                    });
                    const details = await detailsResponse.json();

                    await fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${taskId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                            'If-Match': details['@odata.etag']
                        },
                        body: JSON.stringify({percentComplete: 100})
                    });

                    const completedTask = {
                        ...task,
                        completedDateTime: new Date().toISOString(),
                        percentComplete: 100
                    };
                    const updatedHistory = [completedTask, ...completedTasksHistory];
                    setCompletedTasksHistory(updatedHistory);
                    localStorage.setItem('completedTasksHistory', JSON.stringify(updatedHistory));

                    if (focusTask?.id === taskId) {
                        setFocusTask(null);
                        setFocusStartTime(null);
                        setFocusElapsed(0);
                    }

                    await fetchAllTasks();
                } catch (err) {
                    setError(err.message);
                }
            };

            const handleSetFocusTask = (task) => {
                if (focusTask?.id === task.id) {
                    setFocusTask(null);
                    setFocusStartTime(null);
                    setFocusElapsed(0);
                } else {
                    setFocusTask(task);
                    setFocusStartTime(Date.now());
                    setFocusElapsed(0);
                }
            };

            const toggleWorkTimer = () => {
                if (isWorkTimerRunning) {
                    setIsWorkTimerRunning(false);
                    setWorkStartTime(null);
                } else {
                    setIsWorkTimerRunning(true);
                    setWorkStartTime(Date.now() - (workElapsed * 1000));
                }
            };

            const stopWorkTimer = () => {
                setIsWorkTimerRunning(false);
                setWorkStartTime(null);
                setWorkElapsed(0);
            };

            const formatTime = (seconds) => {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            const getBucketName = (task) => {
                const planBuckets = buckets[task.planId] || [];
                const bucket = planBuckets.find(b => b.id === task.bucketId);
                return bucket ? bucket.name : 'Unknown Bucket';
            };

            const getPriorityLabel = (priority) => {
                const labels = {1: 'Urgent', 3: 'Important', 5: 'Medium', 9: 'Low'};
                return labels[priority] || 'Medium';
            };

            const getPriorityColor = (priority) => {
                const colors = {1: 'bg-red-100 text-red-700', 3: 'bg-orange-100 text-orange-700', 5: 'bg-blue-100 text-blue-700', 9: 'bg-slate-100 text-slate-700'};
                return colors[priority] || 'bg-blue-100 text-blue-700';
            };

            const isOverdue = (task) => {
                if (!task.dueDateTime) return false;
                return new Date(task.dueDateTime) < new Date() && task.percentComplete < 100;
            };

            const getDaysUntilDue = (task) => {
                if (!task.dueDateTime) return null;
                const dueDate = new Date(task.dueDateTime);
                const today = new Date();
                const diffTime = dueDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            };

            const sortTasks = (tasksToSort) => {
                const incompleteTasks = tasksToSort.filter(task => task.percentComplete < 100);
                
                switch (sortMode) {
                    case 'myOrder':
                        return incompleteTasks.sort((a, b) => {
                            const indexA = customOrder.indexOf(a.id);
                            const indexB = customOrder.indexOf(b.id);
                            if (indexA === -1 && indexB === -1) return 0;
                            if (indexA === -1) return 1;
                            if (indexB === -1) return -1;
                            return indexA - indexB;
                        });
                    case 'priority':
                        return incompleteTasks.sort((a, b) => (a.priority || 5) - (b.priority || 5));
                    case 'dueDate':
                        return incompleteTasks.sort((a, b) => {
                            if (!a.dueDateTime && !b.dueDateTime) return 0;
                            if (!a.dueDateTime) return 1;
                            if (!b.dueDateTime) return -1;
                            return new Date(a.dueDateTime) - new Date(b.dueDateTime);
                        });
                    default:
                        return incompleteTasks;
                }
            };

            const handleDragStart = (task) => {
                setDraggedTask(task);
            };

            const handleDragOver = (e, targetTask) => {
                e.preventDefault();
                if (!draggedTask || draggedTask.id === targetTask.id) return;

                const sortedTasks = sortTasks(tasks);
                const draggedIndex = sortedTasks.findIndex(t => t.id === draggedTask.id);
                const targetIndex = sortedTasks.findIndex(t => t.id === targetTask.id);

                if (draggedIndex === -1 || targetIndex === -1) return;

                const newOrder = [...customOrder];
                const draggedId = draggedTask.id;
                const targetId = targetTask.id;

                const currentDraggedIndex = newOrder.indexOf(draggedId);
                if (currentDraggedIndex !== -1) {
                    newOrder.splice(currentDraggedIndex, 1);
                }

                const currentTargetIndex = newOrder.indexOf(targetId);
                if (currentTargetIndex !== -1) {
                    newOrder.splice(currentTargetIndex, 0, draggedId);
                } else {
                    newOrder.push(draggedId);
                }

                setCustomOrder(newOrder);
            };

            const handleDragEnd = () => {
                setDraggedTask(null);
            };

            const moveTaskUp = (task) => {
                const sortedTasks = sortTasks(tasks);
                const currentIndex = sortedTasks.findIndex(t => t.id === task.id);
                if (currentIndex <= 0) return;

                const newOrder = sortedTasks.map(t => t.id);
                [newOrder[currentIndex], newOrder[currentIndex - 1]] = [newOrder[currentIndex - 1], newOrder[currentIndex]];
                setCustomOrder(newOrder);
            };

            const moveTaskDown = (task) => {
                const sortedTasks = sortTasks(tasks);
                const currentIndex = sortedTasks.findIndex(t => t.id === task.id);
                if (currentIndex === -1 || currentIndex >= sortedTasks.length - 1) return;

                const newOrder = sortedTasks.map(t => t.id);
                [newOrder[currentIndex], newOrder[currentIndex + 1]] = [newOrder[currentIndex + 1], newOrder[currentIndex]];
                setCustomOrder(newOrder);
            };

            const getDateRangeStart = () => {
                const now = new Date();
                switch (dateRange) {
                    case '7days':
                        return new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    case '30days':
                        return new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    case '90days':
                        return new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    default:
                        return new Date(0);
                }
            };

            const getFilteredCompletedTasks = () => {
                const startDate = getDateRangeStart();
                return completedTasksHistory.filter(task => {
                    const completedDate = new Date(task.completedDateTime);
                    return completedDate >= startDate;
                });
            };

            const calculateDashboardMetrics = () => {
                const filteredTasks = getFilteredCompletedTasks();
                const totalCompleted = filteredTasks.length;
                
                const totalFocusTime = filteredTasks.reduce((sum, task) => {
                    return sum + (task.focusTime || 0);
                }, 0);

                const avgFocusTime = totalCompleted > 0 ? Math.round(totalFocusTime / totalCompleted / 60) : 0;

                const completionRate = tasks.length > 0 
                    ? Math.round((totalCompleted / (totalCompleted + tasks.filter(t => t.percentComplete < 100).length)) * 100)
                    : 0;

                const currentStreak = calculateStreak();

                return {
                    totalCompleted,
                    avgFocusTime,
                    completionRate,
                    currentStreak
                };
            };

            const calculateStreak = () => {
                if (completedTasksHistory.length === 0) return 0;

                const sortedTasks = [...completedTasksHistory].sort((a, b) => 
                    new Date(b.completedDateTime) - new Date(a.completedDateTime)
                );

                let streak = 0;
                let currentDate = new Date();
                currentDate.setHours(0, 0, 0, 0);

                for (const task of sortedTasks) {
                    const taskDate = new Date(task.completedDateTime);
                    taskDate.setHours(0, 0, 0, 0);

                    const daysDiff = Math.floor((currentDate - taskDate) / (1000 * 60 * 60 * 24));

                    if (daysDiff === streak) {
                        streak++;
                    } else if (daysDiff > streak) {
                        break;
                    }
                }

                return streak;
            };

            const dashboardMetrics = calculateDashboardMetrics();

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 flex items-center justify-center p-4">
                        <div className="max-w-md w-full">
                            <div className="text-center mb-8">
                                <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl mb-6 shadow-lg">
                                    <Target />
                                </div>
                                <h1 className="text-4xl font-light text-slate-800 mb-2">Focus Task Manager</h1>
                                <p className="text-slate-600">Streamline your workflow with Microsoft Planner</p>
                            </div>
                            <div className="bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
                                <button onClick={handleLogin} disabled={loading} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 px-6 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all font-medium text-lg shadow-lg hover:shadow-xl disabled:opacity-50">
                                    {loading ? 'Signing In...' : 'Sign in with Microsoft'}
                                </button>
                                <p className="text-xs text-slate-500 text-center mt-4">Secure authentication via Microsoft</p>
                            </div>
                        </div>
                    </div>
                );
            }

            const sortedTasks = sortTasks(tasks);

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md">
                                            <Target />
                                        </div>
                                        <h1 className="text-2xl font-light text-slate-800">Focus Task Manager</h1>
                                    </div>
                                    {user && (
                                        <span className="text-sm text-slate-600 hidden sm:inline">Welcome, {user.displayName}</span>
                                    )}
                                </div>
                                <div className="flex items-center gap-3">
                                    <button 
                                        onClick={() => setShowDashboard(!showDashboard)}
                                        className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors text-sm font-medium ${
                                            showDashboard 
                                                ? 'bg-indigo-100 text-indigo-700 border border-indigo-200' 
                                                : 'bg-white border border-slate-200 text-slate-700 hover:bg-slate-50'
                                        }`}
                                    >
                                        <BarChart />
                                        Dashboard
                                    </button>
                                    <button onClick={fetchAllTasks} disabled={loading} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 transition-colors text-sm font-medium text-slate-700">
                                        <RefreshCw className={loading ? 'animate-spin' : ''} />
                                        Refresh
                                    </button>
                                    <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 transition-colors text-sm font-medium text-slate-700">
                                        <LogOut />
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {error && (
                            <div className="mb-6 bg-red-50 border border-red-200 rounded-xl p-4 flex items-start gap-3">
                                <div className="flex-shrink-0 mt-0.5"><AlertCircle /></div>
                                <div className="flex-1">
                                    <h3 className="text-sm font-medium text-red-800 mb-1">Error</h3>
                                    <p className="text-sm text-red-700">{error}</p>
                                </div>
                                <button onClick={() => setError(null)} className="flex-shrink-0 text-red-400 hover:text-red-600">
                                    <X />
                                </button>
                            </div>
                        )}

                        {/* Dashboard Section */}
                        {showDashboard && (
                            <div className="mb-8">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-xl font-light text-slate-800">Performance Dashboard</h2>
                                    <select 
                                        value={dateRange} 
                                        onChange={(e) => setDateRange(e.target.value)}
                                        className="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                    >
                                        <option value="7days">Last 7 Days</option>
                                        <option value="30days">Last 30 Days</option>
                                        <option value="90days">Last 90 Days</option>
                                        <option value="all">All Time</option>
                                    </select>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-medium text-slate-600">Tasks Completed</span>
                                            <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                                <Check />
                                            </div>
                                        </div>
                                        <div className="text-3xl font-bold text-slate-800">{dashboardMetrics.totalCompleted}</div>
                                        <p className="text-xs text-slate-500 mt-1">in selected period</p>
                                    </div>

                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-medium text-slate-600">Avg Focus Time</span>
                                            <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                                <Clock />
                                            </div>
                                        </div>
                                        <div className="text-3xl font-bold text-slate-800">{dashboardMetrics.avgFocusTime}</div>
                                        <p className="text-xs text-slate-500 mt-1">minutes per task</p>
                                    </div>

                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-medium text-slate-600">Completion Rate</span>
                                            <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                                <TrendingUp />
                                            </div>
                                        </div>
                                        <div className="text-3xl font-bold text-slate-800">{dashboardMetrics.completionRate}%</div>
                                        <p className="text-xs text-slate-500 mt-1">of total tasks</p>
                                    </div>

                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-medium text-slate-600">Current Streak</span>
                                            <div className="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                                <Zap />
                                            </div>
                                        </div>
                                        <div className="text-3xl font-bold text-slate-800">{dashboardMetrics.currentStreak}</div>
                                        <p className="text-xs text-slate-500 mt-1">consecutive days</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Work Timer */}
                        <div className="mb-6 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-lg p-6 text-white">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <Clock />
                                    <div>
                                        <h3 className="text-lg font-medium">Work Session Timer</h3>
                                        <p className="text-indigo-100 text-sm">Track your total work time today</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="text-3xl font-mono font-bold">{formatTime(workElapsed)}</div>
                                    <div className="flex gap-2">
                                        <button onClick={toggleWorkTimer} className="p-3 bg-white/20 hover:bg-white/30 rounded-xl transition-colors backdrop-blur-sm">
                                            {isWorkTimerRunning ? <Pause /> : <Play />}
                                        </button>
                                        <button onClick={stopWorkTimer} className="p-3 bg-white/20 hover:bg-white/30 rounded-xl transition-colors backdrop-blur-sm">
                                            <Square />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Focus Task */}
                        {focusTask && (
                            <div className="mb-6 bg-white rounded-2xl shadow-lg border-2 border-indigo-500 p-6">
                                <div className="flex items-center justify-between">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-3 mb-2">
                                            <div className="w-3 h-3 bg-indigo-500 rounded-full animate-pulse"></div>
                                            <h3 className="text-lg font-medium text-slate-800">Current Focus Task</h3>
                                        </div>
                                        <h4 className="text-2xl font-light text-slate-900 mb-2">{focusTask.title}</h4>
                                        <div className="flex items-center gap-4 text-sm text-slate-600">
                                            <span className="flex items-center gap-1"><Folder />{plans[focusTask.planId]}</span>
                                            <span>{getBucketName(focusTask)}</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <div className="text-right">
                                            <div className="text-sm text-slate-600 mb-1">Focus Time</div>
                                            <div className="text-3xl font-mono font-bold text-indigo-600">{formatTime(focusElapsed)}</div>
                                        </div>
                                        <button onClick={() => handleCompleteTask(focusTask.id)} className="px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-colors font-medium shadow-md hover:shadow-lg">
                                            Complete Task
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Task Controls */}
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-4">
                                <h2 className="text-xl font-light text-slate-800">My Tasks</h2>
                                <span className="px-3 py-1 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">
                                    {sortedTasks.length} active
                                </span>
                            </div>
                            <div className="flex items-center gap-3">
                                <select value={sortMode} onChange={(e) => setSortMode(e.target.value)} className="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                                    <option value="myOrder">My Order</option>
                                    <option value="priority">Priority</option>
                                    <option value="dueDate">Due Date</option>
                                </select>
                                <button onClick={() => setShowNewTaskModal(true)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium shadow-md hover:shadow-lg">
                                    <Plus />
                                    New Task
                                </button>
                            </div>
                        </div>

                        {/* Task List */}
                        {loading && tasks.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                                <p className="mt-4 text-slate-600">Loading tasks...</p>
                            </div>
                        ) : sortedTasks.length === 0 ? (
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-12 text-center">
                                <div className="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <Check />
                                </div>
                                <h3 className="text-xl font-medium text-slate-800 mb-2">No active tasks</h3>
                                <p className="text-slate-600 mb-6">Create a new task to get started</p>
                                <button onClick={() => setShowNewTaskModal(true)} className="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium shadow-md">
                                    <Plus />
                                    Create First Task
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {sortedTasks.map((task, index) => (
                                    <div key={task.id} draggable={sortMode === 'myOrder'} onDragStart={() => handleDragStart(task)} onDragOver={(e) => handleDragOver(e, task)} onDragEnd={handleDragEnd} className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 transition-all hover:shadow-md ${focusTask?.id === task.id ? 'ring-2 ring-indigo-500' : ''} ${draggedTask?.id === task.id ? 'opacity-50' : ''}`}>
                                        <div className="flex items-start gap-4">
                                            {sortMode === 'myOrder' && (
                                                <div className="flex flex-col gap-1 pt-1">
                                                    <button onClick={() => moveTaskUp(task)} disabled={index === 0} className="p-1 hover:bg-slate-100 rounded disabled:opacity-30 disabled:cursor-not-allowed">
                                                        <ChevronUp />
                                                    </button>
                                                    <div className="cursor-move text-slate-400 hover:text-slate-600">
                                                        <GripVertical />
                                                    </div>
                                                    <button onClick={() => moveTaskDown(task)} disabled={index === sortedTasks.length - 1} className="p-1 hover:bg-slate-100 rounded disabled:opacity-30 disabled:cursor-not-allowed">
                                                        <ChevronDown />
                                                    </button>
                                                </div>
                                            )}
                                            <div className="flex-1">
                                                <div className="flex items-start justify-between mb-3">
                                                    <div className="flex-1">
                                                        <h3 className="text-lg font-medium text-slate-900 mb-2">{task.title}</h3>
                                                        <div className="flex flex-wrap items-center gap-3 text-sm text-slate-600">
                                                            <span className="flex items-center gap-1"><Folder />{plans[task.planId]}</span>
                                                            <span className="flex items-center gap-1">{getBucketName(task)}</span>
                                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${getPriorityColor(task.priority)}`}>
                                                                {getPriorityLabel(task.priority)}
                                                            </span>
                                                            {task.dueDateTime && (
                                                                <span className={`flex items-center gap-1 ${isOverdue(task) ? 'text-red-600 font-medium' : ''}`}>
                                                                    <Calendar />
                                                                    {new Date(task.dueDateTime).toLocaleDateString()}
                                                                    {getDaysUntilDue(task) !== null && (
                                                                        <span className="text-xs">({getDaysUntilDue(task)} days)</span>
                                                                    )}
                                                                </span>
                                                            )}
                                                            {task.assignments && Object.keys(task.assignments).length > 0 && (
                                                                <span className="flex items-center gap-1">
                                                                    <Users />
                                                                    {Object.keys(task.assignments).map(userId => userProfiles[userId] || 'Unknown').join(', ')}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button onClick={() => handleSetFocusTask(task)} className={`p-2 rounded-lg transition-colors ${focusTask?.id === task.id ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`} title={focusTask?.id === task.id ? 'Stop focusing' : 'Focus on this task'}>
                                                            <Target />
                                                        </button>
                                                        <button onClick={() => setEditingTask(task)} className="p-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-colors">
                                                            <Edit />
                                                        </button>
                                                        <button onClick={() => handleCompleteTask(task.id)} className="p-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200 transition-colors">
                                                            <Check />
                                                        </button>
                                                    </div>
                                                </div>
                                                {isOverdue(task) && (
                                                    <div className="flex items-center gap-2 text-sm text-red-600 bg-red-50 rounded-lg px-3 py-2">
                                                        <AlertCircle />
                                                        <span className="font-medium">Overdue</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {showNewTaskModal && (
                        <NewTaskModal accessToken={accessToken} plans={plans} buckets={buckets} onClose={() => setShowNewTaskModal(false)} onTaskCreated={() => {setShowNewTaskModal(false); fetchAllTasks();}} />
                    )}

                    {editingTask && (
                        <EditTaskModal task={editingTask} accessToken={accessToken} plans={plans} buckets={buckets} onClose={() => setEditingTask(null)} onTaskUpdated={() => {setEditingTask(null); fetchAllTasks();}} />
                    )}
                </div>
            );
        }

        function EditTaskModal({task, accessToken, plans, buckets, onClose, onTaskUpdated}) {
            const [title, setTitle] = useState(task.title || '');
            const [description, setDescription] = useState('');
            const [selectedPlan, setSelectedPlan] = useState(task.planId || '');
            const [selectedBucket, setSelectedBucket] = useState(task.bucketId || '');
            const [dueDate, setDueDate] = useState(task.dueDateTime ? task.dueDateTime.split('T')[0] : '');
            const [priority, setPriority] = useState(task.priority?.toString() || '5');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchTaskDetails = async () => {
                    try {
                        const response = await fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${task.id}/details`, {
                            headers: {'Authorization': `Bearer ${accessToken}`}
                        });
                        const details = await response.json();
                        setDescription(details.description || '');
                    } catch (err) {
                        console.error('Error fetching task details:', err);
                    }
                };
                fetchTaskDetails();
            }, [task.id, accessToken]);

            const availableBuckets = selectedPlan ? (buckets[selectedPlan] || []) : [];

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);

                try {
                    const detailsResponse = await fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${task.id}/details`, {
                        headers: {'Authorization': `Bearer ${accessToken}`}
                    });
                    const details = await detailsResponse.json();

                    await fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${task.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                            'If-Match': details['@odata.etag']
                        },
                        body: JSON.stringify({
                            title,
                            bucketId: selectedBucket,
                            dueDateTime: dueDate ? new Date(dueDate).toISOString() : null,
                            priority: parseInt(priority)
                        })
                    });

                    if (description !== details.description) {
                        await fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${task.id}/details`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json',
                                'If-Match': details['@odata.etag']
                            },
                            body: JSON.stringify({description})
                        });
                    }

                    onTaskUpdated();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6 border-b border-slate-200">
                            <div className="flex items-center justify-between">
                                <h2 className="text-2xl font-light text-slate-800">Edit Task</h2>
                                <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg transition-colors"><X /></button>
                            </div>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
                                    <div className="flex-shrink-0 mt-0.5"><AlertCircle /></div>
                                    <p className="text-sm text-red-800">{error}</p>
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">Task Title *</label>
                                <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">Description</label>
                                <textarea value={description} onChange={(e) => setDescription(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" rows="3" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Plan *</label>
                                    <select value={selectedPlan} onChange={(e) => setSelectedPlan(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required>
                                        <option value="">Select a plan</option>
                                        {Object.entries(plans).map(([id, name]) => (<option key={id} value={id}>{name}</option>))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Bucket *</label>
                                    <select value={selectedBucket} onChange={(e) => setSelectedBucket(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required disabled={!selectedPlan}>
                                        <option value="">Select a bucket</option>
                                        {availableBuckets.map((bucket) => (<option key={bucket.id} value={bucket.id}>{bucket.name}</option>))}
                                    </select>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Due Date</label>
                                    <input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Priority</label>
                                    <select value={priority} onChange={(e) => setPriority(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="1">Urgent</option>
                                        <option value="3">Important</option>
                                        <option value="5">Medium</option>
                                        <option value="9">Low</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex gap-3 pt-4">
                                <button type="button" onClick={onClose} className="flex-1 px-6 py-3 border border-slate-300 text-slate-700 rounded-xl hover:bg-slate-50 transition-colors font-medium">Cancel</button>
                                <button type="submit" disabled={loading} className="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium disabled:opacity-50">{loading ? 'Saving...' : 'Save Changes'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function NewTaskModal({accessToken, plans, buckets, onClose, onTaskCreated}) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [selectedPlan, setSelectedPlan] = useState('');
            const [selectedBucket, setSelectedBucket] = useState('');
            const [dueDate, setDueDate] = useState('');
            const [priority, setPriority] = useState('medium');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const availableBuckets = selectedPlan ? (buckets[selectedPlan] || []) : [];

            const priorityMap = {high: 1, medium: 5, low: 9};

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);

                try {
                    const taskData = {
                        planId: selectedPlan,
                        bucketId: selectedBucket,
                        title: title,
                        priority: priorityMap[priority]
                    };

                    if (dueDate) {
                        taskData.dueDateTime = new Date(dueDate).toISOString();
                    }

                    const response = await fetch('https://graph.microsoft.com/v1.0/planner/tasks', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(taskData)
                    });

                    const newTask = await response.json();

                    if (description) {
                        await fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${newTask.id}/details`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json',
                                'If-Match': 'W/"JzEtVGFzayAgQEBAQEBAQEBAQEBAQEBARCc="'
                            },
                            body: JSON.stringify({description})
                        });
                    }
                    onTaskCreated();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6 border-b border-slate-200">
                            <div className="flex items-center justify-between">
                                <h2 className="text-2xl font-light text-slate-800">Create New Task</h2>
                                <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg transition-colors"><X /></button>
                            </div>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
                                    <div className="flex-shrink-0 mt-0.5"><AlertCircle /></div>
                                    <p className="text-sm text-red-800">{error}</p>
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">Task Title *</label>
                                <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter task title" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">Description</label>
                                <textarea value={description} onChange={(e) => setDescription(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter task description" rows="3" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Plan *</label>
                                    <select value={selectedPlan} onChange={(e) => setSelectedPlan(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required>
                                        <option value="">Select a plan</option>
                                        {Object.entries(plans).map(([id, name]) => (<option key={id} value={id}>{name}</option>))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Bucket *</label>
                                    <select value={selectedBucket} onChange={(e) => setSelectedBucket(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required disabled={!selectedPlan}>
                                        <option value="">Select a bucket</option>
                                        {availableBuckets.map((bucket) => (<option key={bucket.id} value={bucket.id}>{bucket.name}</option>))}
                                    </select>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Due Date</label>
                                    <input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Priority</label>
                                    <select value={priority} onChange={(e) => setPriority(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex gap-3 pt-4">
                                <button type="button" onClick={onClose} className="flex-1 px-6 py-3 border border-slate-300 text-slate-700 rounded-xl hover:bg-slate-50 transition-colors font-medium">Cancel</button>
                                <button type="submit" disabled={loading} className="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-medium disabled:opacity-50">{loading ? 'Creating...' : 'Create Task'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FocusTaskManager />);
    </script>
</body>
</html>
